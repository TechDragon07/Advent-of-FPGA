open! Core
open! Hardcaml
open! Day07_dune 

let input =
  "......................................................................S......................................................................\n\
   .............................................................................................................................................\n\
   ......................................................................^......................................................................\n\
   .............................................................................................................................................\n\
   .....................................................................^.^.....................................................................\n\
   .............................................................................................................................................\n\
   ....................................................................^...^....................................................................\n\
   .............................................................................................................................................\n\
   ...................................................................^...^.^...................................................................\n\
   .............................................................................................................................................\n\
   ..................................................................^.^.^.^.^..................................................................\n\
   .............................................................................................................................................\n\
   .................................................................^.^.^.^.^.^.................................................................\n\
   .............................................................................................................................................\n\
   ................................................................^.^.......^.^................................................................\n\
   .............................................................................................................................................\n\
   ...............................................................^.....^.....^.^...............................................................\n\
   .............................................................................................................................................\n\
   ..............................................................^.^.........^...^..............................................................\n\
   .............................................................................................................................................\n\
   .............................................................^.^...^.....^.^.^.^.............................................................\n\
   .............................................................................................................................................\n\
   ............................................................^.^.^.....^.^.^...^.^............................................................\n\
   .............................................................................................................................................\n\
   ...........................................................^.^.....^...^...^.^.^.^...........................................................\n\
   .............................................................................................................................................\n\
   ..........................................................^.^.^.^.^.^...^.......^.^..........................................................\n\
   .............................................................................................................................................\n\
   .........................................................^.^.^...^.^...^.^.^.....^.^.........................................................\n\
   .............................................................................................................................................\n\
   ........................................................^.^.^...^.^.^.....^.^.^.^...^........................................................\n\
   .............................................................................................................................................\n\
   .......................................................^...^.^...^.^.^.^.^.^.^...^.^.^.......................................................\n\
   .............................................................................................................................................\n\
   ......................................................^.^.....^.....^.^...^.^.^.^.....^......................................................\n\
   .............................................................................................................................................\n\
   .....................................................^.....^.^.^.^...^.^.^.^.^.^.^.^.^.^.....................................................\n\
   .............................................................................................................................................\n\
   ....................................................^...^.^.^.^...^...^.^.^.^...^.^.....^....................................................\n\
   .............................................................................................................................................\n\
   ...................................................^.^...^.^.^...^.^.....^.^.^.^.^...^.^.^...................................................\n\
   .............................................................................................................................................\n\
   ..................................................^.......^...^.^.^.^.^.^.^.^.^.^.^.^.....^..................................................\n\
   .............................................................................................................................................\n\
   .................................................^...^...^...^.^.^.........^...^.^.....^.^.^.................................................\n\
   .............................................................................................................................................\n\
   ................................................^...^.^.....^.^.^...^.^.^.^.^.^.......^...^.^................................................\n\
   .............................................................................................................................................\n\
   ...............................................^.^...^...^.........^.^.^.^.^.^.....^.^.....^.^...............................................\n\
   .............................................................................................................................................\n\
   ..............................................^.^...^...^.^.^.^.^.^.^.^...^.^.^.^...^.^.^.....^..............................................\n\
   .............................................................................................................................................\n\
   .............................................^.^.^...^...^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.^...^.............................................\n\
   .............................................................................................................................................\n\
   ............................................^...^.^.^.^.....^.^...^.^.^.^.^.....^.^.^...^.^.^...^............................................\n\
   .............................................................................................................................................\n\
   ...........................................^.^.^.......^.^.^...^...^...^...^.....^...^.^.^.^.....^...........................................\n\
   .............................................................................................................................................\n\
   ..........................................^...^.^.^.^.^...^.^.^.^.^.^...^.^...^.^.^...^.^.^...^.^.^..........................................\n\
   .............................................................................................................................................\n\
   .........................................^...^.^...^.^.......^...^.^...^.^...^.^.^.^.^.^.^.^.^...^.^.........................................\n\
   .............................................................................................................................................\n\
   ........................................^.^...^.^.........^.^.^.^.^.^.....^.^.^.....^.^.^.^.^...^...^........................................\n\
   .............................................................................................................................................\n\
   .......................................^.^.^.^...^.....^.^.^.^.^...^.^...^.^.^.^.^.^...^.^.^...^...^.^.......................................\n\
   .............................................................................................................................................\n\
   ......................................^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^...^.....^.^.^...^.^.^.^.^.^.^.^......................................\n\
   .............................................................................................................................................\n\
   .....................................^.^.^.^.^.^.^.^...^.^...^.^.^.^...^.....^.^.^...^.^...^.^.^...^...^.....................................\n\
   .............................................................................................................................................\n\
   ....................................^.^.......^.^.^...^.^.^.^.^...^.^.^...^.^...^...^...^.....^.^.....^.^....................................\n\
   .............................................................................................................................................\n\
   ...................................^.^.^.^.^.^.....^.^.^.^.^.^.^...^.^...^...^.^.^...^.^.^.^...^.^...^...^...................................\n\
   .............................................................................................................................................\n\
   ..................................^.....^.^.^.^...^.^.^.^.^.^...^.^.......^...^.^.^.^.^...^.^.^...^...^...^..................................\n\
   .............................................................................................................................................\n\
   .................................^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^...^...^.....^.^.^.^.^.^...^.^.....^.................................\n\
   .............................................................................................................................................\n\
   ................................^.^...^.^.^.^.^.^...^.^.^...^...^.^.^.^.^...^...^.....^.^.^.^.^.....^.....^.^................................\n\
   .............................................................................................................................................\n\
   ...............................^.....^.^.^.^.^.^...^.^.^.^...^.^...^.....^...^.....^...^...^.^...^.^.^...^.^.^...............................\n\
   .............................................................................................................................................\n\
   ..............................^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.....^.^.^...........^.^...^...^...^.^..............................\n\
   .............................................................................................................................................\n\
   .............................^...^.....^.^.^.^...^.....^.^.^.^.........^.^.^...^.^.^...^.^.^.^.^.^.^.^.^.^...^...^.............................\n\
   .............................................................................................................................................\n\
   ............................^.^.^...^.^.^.^...^.....^.^.^.^.^...^.^.^.^.^...^...^.^.^.^.^...^.^.^.^...^.^.^.^...^............................\n\
   .............................................................................................................................................\n\
   ...........................^.^.......^.....^.^.....^...^.^.^...^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.......^.^.^...^...........................\n\
   .............................................................................................................................................\n\
   ..........................^.^.^.^.....^.^.^.......^...^.^...^...^.^.^.^.....^...^.^.^.^...^.^...^...^.^.^...^.^...^..........................\n\
   .............................................................................................................................................\n\
   .........................^...^...^.^.^.^...^...^.^.^.^...^.^.^.^.^...^.^.........^.^.^.^.^...^.^.^...^.....^.......^.........................\n\
   .............................................................................................................................................\n\
   ........................^.^...^.^.^.^.^.^.^...^.^.^...^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.^.....^.^.^.....^........................\n\
   .............................................................................................................................................\n\
   .......................^.^.^.......^.^...^.^.^.^.^.^...^.......^.^.^.^.^...^...^.^...^.^.^.^.^.^.^.^...^.^...^.^.^...^.......................\n\
   .............................................................................................................................................\n\
   ......................^.^.^...^.^.^...^.^.^.^.^...^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.....^.^...^.^.^.^.^.^.^.^.......^......................\n\
   .............................................................................................................................................\n\
   .....................^.^.^.^...^...^.^...^.^.^.^.^.^...^.^.^.....^.^...^.....^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.....................\n\
   .............................................................................................................................................\n\
   ....................^.^.^.^.^.^.^.^.^.^.........^.^.^...^.^.^.^.......^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^...^.....^.^....................\n\
   .............................................................................................................................................\n\
   ...................^.^.^.^.^.^.^.....^.^.^.^.^.^.....^.^.....^.^.....^.^.........^...^...^.^...^.^...^.^.^.^.^.^.^.^.....^...................\n\
   .............................................................................................................................................\n\
   ..................^.....^...^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.....^.......^...^...^.......^.^.^.^.^.^...^.^.....^..................\n\
   .............................................................................................................................................\n\
   .................^.^.^.^...^.^.^.^.........^.^.^.....^.^.^.^.......^...^.^...^...^.^.^.....^.^...^...^.^.^.....^.^...^.^.^.^.................\n\
   .............................................................................................................................................\n\
   ................^...^.^...^.^...^.^.^.^.^...^.^.........^...^.^.....^...^.^...^.^...^.^...^.^.^.^.^.^...^.^.^...^.^.^.^.^...^................\n\
   .............................................................................................................................................\n\
   ...............^.^.^.......^.^.^...^.^.^.^.^...^...^.^...^...^.^.^.^...^.^.^.^.^.^.^.^...^.^...^.....^...^.^...^.^.....^.^...^...............\n\
   .............................................................................................................................................\n\
   ..............^...^.....^.^.^.^.^.^...^...^.....^.^.^.^.^.^...^.^.^.^...^.^.^...^...^.^.^.......^...^.^...^.^.^.^.......^.^...^..............\n\
   .............................................................................................................................................\n\
   .............^...^...^.^...^.^.^.^.^.^...^...^.^.^.^.^.^.....^...^...^.....^...^.^.....^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^.^...^.............\n\
   .............................................................................................................................................\n\
   ............^...^.^.^...^.^...^.^.^.^.^.......^.^.....^.....^.^.^.^.^...^.^.^.^...^.....^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^............\n\
   .............................................................................................................................................\n\
   ...........^.^.^.....^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.....^...^.^.^...^.^...^.^.^...^.^.^.^...^.^.^...^...^.^.^.^...^.....^.^.^.^...........\n\
   .............................................................................................................................................\n\
   ..........^.^.^.^...^.^...^...^...........^.^.^.^.^.^.^.^...^.^.^.^.^.^...........^.^.^...^.^.^.^.....^.^.^.^.^.^.^.^.^...^.^.^.^.^..........\n\
   .............................................................................................................................................\n\
   .........^.^.^.^...^.^...^...^...^.......^...^.^.....^.^.^.....^.^.^.^...^.^...^.^.^.^.....^.^.^.^.^...^.^...^.^...^.^...^.^...^.^...^.........\n\
   .............................................................................................................................................\n\
   ........^.^.....^.^.^.^...^.^.^.^.....^.^...^.^.^.^.....^.^.^.^.^.^.^.^...^.^.....^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.^.^...^........\n\
   .............................................................................................................................................\n\
   .......^.^.^.^.^.....^.....^.^.^.^.^...^...^...^...^.^.^.^.^.......^...^.^...^.^.^.^.^.^.^...^.^.^...^.^.^.^...^.^.^.^.^...^.^.^...^.^.......\n\
   .............................................................................................................................................\n\
   ......^.^.^.^.^...^.^.^...^.^.^.^.^.^.^.^...^.^...^.^.^...^.^.^.^.^.^...^.^.....^...^.^.^...^.^...^.....^.^.^.^.^.^.^.^.^.^.^.....^.^.^......\n\
   .............................................................................................................................................\n\
   .....^.^.^.^.^.^.^.^...^.^.^.......^.^.^.^...^.^.^.....^.^.....^.^...^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.^.....^.^.^.^.^.^...^.....\n\
   .............................................................................................................................................\n\
   ....^...^.^.^.^.^.^.^...^.^.^...^.^.^.^...^.^.^.....^.^...^.^.^.^...^.^.^.....^.^.^.^.^.....^.^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^....\n\
   .............................................................................................................................................\n\
   ...^...^.......^.^...^.^.^.^...^.^.^.^.....^...^.^.......^.^.^.^.^.^.^.^...^.^.....^.^.^.^.^.^.^.^.....^.^...^...^.^.^.....^...^.......^.^...\n\
   .............................................................................................................................................\n\
   ..^.^.^...^.^.^.....^.^.^...^...^...^...^.^.^.^.^.^.^.....^.^.^...^.....^.^.^.^.^...^.^...^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.^...^.^.^...^.^..\n\
   .............................................................................................................................................\n\
   .^.^.......^.^.^.^.^.^.^...^.....^.^...^.^.^.^.^.^...^...^.^...^.^.........^.....^.^.^.^.....^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^...^.^...^.^.\n\
   ............................................................................................................................................."

let%expect_test "Day 7 Large Grid Test" =
  let module Sim = Hardcaml_waveterm.Sim.Make (Day07.I) (Day07.O) in
  let sim = Sim.create (Day07.create (Scope.create ())) in
  let inputs = Sim.inputs sim in

  inputs.clear := Bits.vdd;
  Sim.cycle sim;
  inputs.clear := Bits.gnd;

  String.iter input ~f:(fun char ->
    match char with
    | '\n' -> () 
    | c -> 
      inputs.rx_data := Bits.of_char c;
      inputs.rx_valid := Bits.vdd;
      Sim.cycle sim
  );

  inputs.rx_valid := Bits.gnd;
  for _ = 0 to 500 do
    Sim.cycle sim
  done;

  let result = Sim.sample sim in
  Stdio.printf "Part 1: %s\n" (Bits.to_int result.part1 |> Int.to_string);
  Stdio.printf "Part 2: %s\n" (Bits.to_int64 result.part2 |> Int64.to_string);
  [%expect {|
    Part 1: 5212
    Part 2: 74649710592
  |}]


let target_freq_mhz = 100.0

let%expect_test "Day 7 Performance Benchmark" =
  let module Sim = Hardcaml_waveterm.Sim.Make (Day07.I) (Day07.O) in
  let sim = Sim.create (Day07.create (Scope.create ())) in
  let inputs = Sim.inputs sim in
  
  let total_cycles = ref 0 in
  let step_sim n = 
    for _ = 1 to n do 
      Sim.cycle sim; 
      Int.incr total_cycles 
    done 
  in

  inputs.clear := Bits.vdd;
  step_sim 1;
  inputs.clear := Bits.gnd;

  String.iter input ~f:(fun char ->
    match char with
    | '\n' -> ()
    | c -> 
      inputs.rx_data := Bits.of_char c;
      inputs.rx_valid := Bits.vdd;
      step_sim 1);

  inputs.rx_valid := Bits.gnd;
  step_sim 500;

  let completion_us = Float.of_int !total_cycles /. target_freq_mhz in
  let throughput_mops = target_freq_mhz in 

  Stdio.printf "Total Cycles: %d\n" !total_cycles;
  Stdio.printf "Target Frequency: %.2f MHz\n" target_freq_mhz;
  Stdio.printf "Theoretical Completion Time: %.2f us\n" completion_us;
  Stdio.printf "Throughput: %.2f MChars/s\n" throughput_mops;
  
  [%expect {|
    Total Cycles: 20462
    Target Frequency: 100.00 MHz
    Theoretical Completion Time: 204.62 us
    Throughput: 100.00 MChars/s
  |}]
